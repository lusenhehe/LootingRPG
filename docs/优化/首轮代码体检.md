# LootingRPG 首轮代码体检（给第一次做 npm 多端项目的你）

> 目标：先把“能稳定迭代”放在第一优先级，而不是一次性重构完美。

## 1) 当前主要风险（按优先级）

1. **类型系统与运行时模型严重漂移**
   - `src/types/game.ts` 中的 `BattleState` 只有 `activeSession/history`，但实际业务大量访问 `phase/currentMonster/monsterHpPercents` 等字段。
   - 这会导致：TS 报错泛滥、`any` 扩散、改一个地方炸一片。

2. **状态来源过多，边界不清**
   - 目前同时存在 `gameState`、`battleState`、`mapProgress` 等并行状态，且通过多层 hook 传递。
   - 结果是“谁负责真相源（source of truth）”不明确，容易出现 UI 显示与业务结果不一致。

3. **老代码路径残留（魔法字符串）**
   - 例如已删除的 tab 仍被调用（`'status'`），属于重构后的断链。
   - 这类问题不大，但会不断制造小故障，影响体验和排障效率。

4. **模块命名/目录重复语义**
   - 例如 `logic/playerStats.ts` 与 `logic/stats/playerStats.ts`、多处 map/config 文件并存。
   - 新人接手时定位成本高，长期会拖慢开发速度。

## 2) 本次已做的最小修复

- 修复了地图开战时切 tab 使用过期值 `status` 的问题，改为使用合法 `ActiveTab` 常量，避免继续制造类型错误和潜在空白页跳转。
- 这个改动很小，但属于“先止血”的必要补丁。

## 3) 建议你下一步这样收敛（两周内可落地）

### 第 1 步：冻结并统一战斗状态模型
- 只保留一份战斗状态定义（建议在 `types/game.ts` 或 `logic/gameState/battleState.ts` 二选一作为源头）。
- 建立“字段白名单”，把 `phase/currentMonsters/...` 全部显式声明。
- 禁止新增 `any`：改动战斗相关代码时，先补类型再写逻辑。

### 第 2 步：拆分“流程控制”和“数值计算”
- `useBattleFlow/useMapActions` 负责流程（切阶段、调度动画、日志）。
- `battleEngine/damageCalculator` 只做纯函数计算（输入固定、输出固定）。
- 这样你后续接入自动测试会非常容易。

### 第 3 步：建立最低限度的工程护栏
- 每次提交前至少跑：
  - `npm run lint`（先把红线问题逐批清零）
  - 关键流程 smoke test（开局→打一场→掉落→结算）
- 推荐再加一个脚本：仅检查核心目录（battle/map/hooks）的 type health，方便分阶段治理。

## 4) 对“屎山”心态的建议

你这个项目并不是“不能救”，而是典型的**功能跑得快，模型收敛慢**。这在第一款项目非常常见。
正确姿势不是推倒重来，而是：

- 每次改需求时顺手消灭 1~2 个历史坏味道；
- 优先修“会反复踩坑”的边界问题（类型漂移、状态重复）；
- 保持小步提交，让代码质量和功能一起前进。

