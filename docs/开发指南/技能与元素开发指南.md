# 技能与元素开发指南

> 适用版本：Phase 3.d 及以后  
> 配置文件路径：`assets/data/config/game/skills.json` / `assets/data/config/game/elementReactions.json`

---

## 一、技能系统概述

游戏技能的执行流程：

```
玩家/怪物使用技能
    ↓
发出 on_cast 事件
    ↓
引擎查找 skills.json 中对应的 nodes
    ↓
依次执行每个 node（造伤 / 附加状态 / 回复等）
    ↓
触发元素反应检测
```

每个技能由一或多个 **节点（node）** 组成，每个节点对应一种效果。  
节点在 `on_cast` 时同时触发，**顺序按数组顺序执行**。

---

## 二、技能 JSON 结构

### 最简示例

```json
"basic_attack": {
  "id": "basic_attack",
  "name": "Basic Attack",
  "nodes": [
    {
      "id": "basic_attack:hit",
      "trigger": "on_cast",
      "type": "deal_damage",
      "params": {
        "baseDamage": 0,
        "critMultiplier": 1
      }
    }
  ]
}
```

### 多节点示例（造伤 + 附加毒）

```json
"poison_blade": {
  "id": "poison_blade",
  "name": "Poison Blade",
  "nodes": [
    {
      "id": "poison_blade:deal_damage",
      "trigger": "on_cast",
      "type": "deal_damage",
      "params": {
        "baseDamage": 0,
        "critMultiplier": 1
      }
    },
    {
      "id": "poison_blade:apply_poison",
      "trigger": "on_cast",
      "type": "apply_status",
      "params": {
        "statusId": "poison_blade_dot",
        "statusType": "dot",
        "stacks": 1,
        "duration": 3,
        "magnitudeFactor": 0.12,
        "magnitudeBase": "attack",
        "element": "poison"
      }
    }
  ]
}
```

---

## 三、字段详解

### 3.1 技能顶层字段

| 字段 | 类型 | 说明 |
|---|---|---|
| `id` | string | **全局唯一**，与 JSON key 一致，如 `poison_blade` |
| `name` | string | 显示名称（英文） |
| `nodes` | array | 技能效果节点列表（至少一个） |

---

### 3.2 节点 `node` 字段

| 字段 | 类型 | 说明 |
|---|---|---|
| `id` | string | **全局唯一**，格式：`技能ID:效果名`，如  `poison_blade:apply_poison` |
| `trigger` | string | 触发时机，见下表 |
| `type` | string | 效果类型，见下表 |
| `params` | object | 效果参数，根据 `type` 不同而变化 |

---

### 3.3 触发时机 `trigger`

| 值 | 触发时机 |
|---|---|
| `on_cast` | 技能被使用时（最常用） |
| `on_turn_start` | 每回合开始时（用于 DOT/HOT 持续伤害） |
| `on_hit` | 命中敌人时（反击、吸血等） |
| `on_death` | 死亡时触发 |

> 目前主要使用 `on_cast` 即可，其他触发器为规划中特性。

---

### 3.4 效果类型 `type`

当前已实装的效果类型：

#### `deal_damage` — 造成伤害

```json
{
  "type": "deal_damage",
  "params": {
    "baseDamage": 0,
    "critMultiplier": 1
  }
}
```

| 参数 | 说明 |
|---|---|
| `baseDamage` | 固定伤害加成（通常 0，让攻击力决定基础伤害） |
| `critMultiplier` | 暴击倍率（1 = 无暴击加成，1.5 = 暴击+50%） |

> 实际伤害 = (施法者攻击力 + baseDamage) × (1 - 目标减伤率)

---

#### `apply_status` — 附加状态

```json
{
  "type": "apply_status",
  "params": {
    "statusId": "my_poison_dot",
    "statusType": "dot",
    "stacks": 1,
    "duration": 3,
    "magnitudeFactor": 0.12,
    "magnitudeBase": "attack",
    "element": "poison"
  }
}
```

| 参数 | 类型 | 说明 |
|---|---|---|
| `statusId` | string | 状态唯一ID，自定义命名，如 `my_poison_dot` |
| `statusType` | string | 状态类型，见下表 |
| `stacks` | number | 层数（一般 1~5） |
| `duration` | number | 持续回合数 |
| `magnitudeFactor` | number | 每层效果强度倍率（如 0.12 = 每层触发 12% 的基准属性） |
| `magnitudeBase` | string | 计算基准属性：`"attack"` / `"hp"` / `"defense"` |
| `element` | string | 状态的元素类型，用于触发元素反应 |

**`statusType` 可选值：**

| 值 | 含义 | 效果描述 |
|---|---|---|
| `dot` | 持续伤害（Damage over Time） | 每回合扣血，量 = magnitudeFactor × magnitudeBase |
| `hot` | 持续回血（Heal over Time） | 每回合回血 |
| `buff` | 增益 | 提升某项属性|
| `debuff` | 减益 | 降低某项属性 |
| `shield` | 护盾 | 抵挡伤害，量 = magnitudeFactor × HP |

---

## 四、数值参考

### DOT（持续伤害）强度参考

| 定位 | magnitudeFactor | duration | 每回合大致伤害 |
|---|---|---|---|
| 轻型毒 | 0.08 | 2~3 | ~8% 攻击力 |
| 标准毒/流血 | 0.12 | 3 | ~12% 攻击力 |
| 重型灼烧 | 0.18 | 3~4 | ~18% 攻击力 |
| 强效瘟疫 | 0.25 | 4~5 | ~25% 攻击力 |

### 护盾强度参考

| 定位 | magnitudeFactor (base=hp) | 效果 |
|---|---|---|
| 轻盾 | 0.12 ~ 0.18 | 约 12~18% HP |
| 标准盾 | 0.20 ~ 0.28 | 约 20~28% HP |
| 重盾 | 0.35 ~ 0.50 | 约 35~50% HP |

---

## 五、技能设计规范

### 命名规范

```
技能 ID：    小写下划线，如 ice_spike、fire_nova
节点 ID：    技能ID:效果描述，如 ice_spike:deal_damage
状态 ID：    技能ID_效果类型，如 ice_spike_slow
```

### 平衡建议

| 技能定位 | 推荐设计 |
|---|---|
| 纯伤害 | `deal_damage` × 1，`critMultiplier` 1.0~1.5 |
| 伤害 + 轻 DOT | `deal_damage` + `apply_status(dot)` |
| 纯控制/减益 | `apply_status(debuff)` × 1~2 层 |
| 护盾/回血 | `apply_status(shield/hot)` |
| 复合技能 | 最多 3 个节点，避免单技能过于强力 |

---

## 六、完整技能示例

### 示例1：冰刺（造伤+减速）

```json
"ice_spike": {
  "id": "ice_spike",
  "name": "Ice Spike",
  "nodes": [
    {
      "id": "ice_spike:deal_damage",
      "trigger": "on_cast",
      "type": "deal_damage",
      "params": {
        "baseDamage": 0,
        "critMultiplier": 1.2
      }
    },
    {
      "id": "ice_spike:apply_chill",
      "trigger": "on_cast",
      "type": "apply_status",
      "params": {
        "statusId": "ice_spike_chill",
        "statusType": "debuff",
        "stacks": 1,
        "duration": 2,
        "magnitudeFactor": 0.1,
        "magnitudeBase": "attack",
        "element": "ice"
      }
    }
  ]
}
```

### 示例2：生命之泉（纯回血）

```json
"life_spring": {
  "id": "life_spring",
  "name": "Life Spring",
  "nodes": [
    {
      "id": "life_spring:apply_hot",
      "trigger": "on_cast",
      "type": "apply_status",
      "params": {
        "statusId": "life_spring_hot",
        "statusType": "hot",
        "stacks": 1,
        "duration": 4,
        "magnitudeFactor": 0.08,
        "magnitudeBase": "hp",
        "element": "water"
      }
    }
  ]
}
```

### 示例3：火焰护盾（附盾 + 附灼烧层）

```json
"flame_shield": {
  "id": "flame_shield",
  "name": "Flame Shield",
  "nodes": [
    {
      "id": "flame_shield:apply_shield",
      "trigger": "on_cast",
      "type": "apply_status",
      "params": {
        "statusId": "flame_shield_barrier",
        "statusType": "shield",
        "stacks": 1,
        "duration": 3,
        "magnitudeFactor": 0.25,
        "magnitudeBase": "hp",
        "element": "fire"
      }
    },
    {
      "id": "flame_shield:apply_burn",
      "trigger": "on_cast",
      "type": "apply_status",
      "params": {
        "statusId": "flame_shield_burn",
        "statusType": "dot",
        "stacks": 1,
        "duration": 2,
        "magnitudeFactor": 0.10,
        "magnitudeBase": "attack",
        "element": "fire"
      }
    }
  ]
}
```

---

## 七、元素系统

### 7.1 当前元素列表

| 元素 | ID | 常见搭配 |
|---|---|---|
| 火 | `fire` | 爆炸、灼烧 |
| 毒 | `poison` | 持续腐蚀 |
| 冰 | `ice` | 减速、冻结 |
| 水 | `water` | 导电、冻结 |
| 雷 | `lightning` | 电解、瘫痪 |

---

### 7.2 元素反应

配置文件：`assets/data/config/game/elementReactions.json`

**当前已定义的元素反应：**

| 组合 | 反应名 | 额外伤害倍率 |
|---|---|---|
| 火 + 毒 | 火毒爆炸 `fire_poison_explosion` | ×0.05（+5%） |
| 冰 + 水 | 冻结 `frozen` | ×0.03（+3%） |
| 雷 + 水 | 电解 `electrolysis` | ×0.08（+8%） |
| 火 + 冰 | 蒸汽爆发 `steam_burst` | ×0.06（+6%） |
| 毒 + 水 | 毒洪 `toxic_flood` | ×0.07（+7%） |
| 雷 + 火 | 等离子爆发 `plasma_burst` | ×0.10（+10%） |

**触发条件**：目标身上同时存在两种元素的状态时，造成伤害会触发对应反应，额外追加一次附加伤害。

---

### 7.3 新增元素反应

在 `elementReactions.json` 中添加新对象：

```json
"fire_ice": {
  "conditions": ["fire", "ice"],
  "reaction": "steam_burst",
  "extraDamageFactor": 0.06
}
```

| 字段 | 说明 |
|---|---|
| `conditions` | 触发所需的两种元素（顺序不影响触发） |
| `reaction` | 反应名称（自定义字符串，用于日志显示） |
| `extraDamageFactor` | 额外伤害倍率：0.05 = 额外 +5% 基础伤害 |

**平衡参考**：
- 轻微反应：0.03 ~ 0.05
- 标准反应：0.06 ~ 0.10  
- 强力反应：0.12 ~ 0.18（慎用，需配合测试）

---

## 八、提交自检清单

- [ ] 技能 `id` 全局唯一，与 JSON key 一致
- [ ] 每个节点 `id` 格式为 `技能ID:效果名`，全局唯一
- [ ] `statusId` 命名清晰，不与其他技能的 `statusId` 冲突
- [ ] DOT `magnitudeFactor` 在 0.08 ~ 0.25 之间（极端情况请说明）
- [ ] 护盾 `magnitudeFactor` 在 0.12 ~ 0.50 之间
- [ ] 元素反应 `extraDamageFactor` 不超过 0.18
- [ ] 已在 `monsters.json` 对应的怪物 `skills` 数组中引用了新技能ID

---

## 九、常见错误

| 错误 | 说明 |
|---|---|
| 节点 `id` 重复 | 会导致引擎混淆监听器，出现技能失效 |
| `magnitudeFactor` 写成百分比整数（如 `12`） | 应为小数 `0.12` |
| `statusType` 拼错（如 `"DOT"`） | 必须小写：`"dot"` |
| 元素写错大小写（如 `"Fire"`） | 必须全小写：`"fire"` |
| 节点 `trigger` 写成 `"onCast"` | 必须用下划线：`"on_cast"` |
