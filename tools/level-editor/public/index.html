<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LootingRPG ÂÖ≥Âç°ÁºñËæëÂô®</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Crimson+Text:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #0A0908;
      --bg-card: #1C1917;
      --bg-card-hover: #292524;
      --border: #292524;
      --border-light: #44403C;
      --text-primary: #E7E5E4;
      --text-secondary: #A8A29E;
      --text-muted: #78716C;
      --accent-violet: #8B5CF6;
      --accent-cyan: #22D3EE;
      --accent-amber: #F59E0B;
      --accent-emerald: #10B981;
      --accent-rose: #F43F5E;
      --glow-violet: rgba(139, 92, 246, 0.3);
      --glow-cyan: rgba(34, 211, 238, 0.2);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Crimson Text', serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      background-image: 
        radial-gradient(ellipse at 20% 0%, rgba(139, 92, 246, 0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 100%, rgba(34, 211, 238, 0.05) 0%, transparent 40%),
        linear-gradient(180deg, #0A0908 0%, #1C1917 100%);
      background-attachment: fixed;
    }

    .app {
      display: grid;
      grid-template-columns: 280px 320px 1fr;
      height: 100vh;
      gap: 12px;
      padding: 12px;
    }

    .panel {
      background: linear-gradient(145deg, rgba(28, 25, 23, 0.95), rgba(28, 25, 23, 0.8));
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 
        0 4px 24px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.03);
    }

    .panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.3), transparent);
    }

    .panel-header {
      padding: 16px 20px;
      font-family: 'Cinzel', serif;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: var(--text-secondary);
      background: linear-gradient(180deg, rgba(41, 37, 36, 0.8), transparent);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }

    .panel-header::before {
      content: '';
      width: 8px;
      height: 8px;
      background: var(--accent-violet);
      border-radius: 50%;
      box-shadow: 0 0 12px var(--accent-violet);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(0.9); }
    }

    .list-container {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .list-container::-webkit-scrollbar {
      width: 6px;
    }

    .list-container::-webkit-scrollbar-track {
      background: transparent;
    }

    .list-container::-webkit-scrollbar-thumb {
      background: rgba(139, 92, 246, 0.3);
      border-radius: 3px;
    }

    .item {
      cursor: pointer;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 14px;
      font-size: 13px;
      transition: all 0.2s ease;
      background: rgba(28, 25, 23, 0.5);
      position: relative;
      overflow: hidden;
    }

    .item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: transparent;
      transition: all 0.2s ease;
    }

    .item:hover {
      border-color: var(--border-light);
      background: var(--bg-card-hover);
      transform: translateX(2px);
    }

    .item.active {
      border-color: var(--accent-violet);
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(28, 25, 23, 0.9));
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.15);
    }

    .item.active::before {
      background: var(--accent-violet);
      box-shadow: 0 0 10px var(--accent-violet);
    }

    .item-id {
      font-family: 'Cinzel', serif;
      font-size: 10px;
      color: var(--accent-cyan);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }

    .item-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .item.active .item-name {
      color: #fff;
    }

    .actions {
      padding: 16px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      background: linear-gradient(0deg, rgba(41, 37, 36, 0.6), transparent);
    }

    button {
      flex: 1;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(41, 37, 36, 0.8), rgba(28, 25, 23, 0.9));
      color: var(--text-secondary);
      border-radius: 8px;
      padding: 10px 14px;
      cursor: pointer;
      font-family: 'Crimson Text', serif;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.4s ease;
    }

    button:hover::before {
      left: 100%;
    }

    button:hover {
      border-color: var(--accent-violet);
      color: var(--text-primary);
      background: linear-gradient(180deg, rgba(139, 92, 246, 0.2), rgba(28, 25, 23, 0.9));
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
    }

    button:active {
      transform: translateY(0);
    }

    button.primary {
      background: linear-gradient(180deg, rgba(139, 92, 246, 0.8), rgba(124, 58, 237, 0.6));
      border-color: rgba(139, 92, 246, 0.5);
      color: #fff;
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
    }

    button.primary:hover {
      background: linear-gradient(180deg, rgba(139, 92, 246, 1), rgba(124, 58, 237, 0.8));
      box-shadow: 0 4px 20px rgba(139, 92, 246, 0.5);
    }

    button.danger:hover {
      border-color: var(--accent-rose);
      color: var(--accent-rose);
      background: rgba(244, 63, 94, 0.1);
      box-shadow: 0 4px 12px rgba(244, 63, 94, 0.2);
    }

    .form {
      padding: 16px;
      overflow-y: auto;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-content: start;
    }

    .form::-webkit-scrollbar {
      width: 6px;
    }

    .form::-webkit-scrollbar-track {
      background: transparent;
    }

    .form::-webkit-scrollbar-thumb {
      background: rgba(139, 92, 246, 0.3);
      border-radius: 3px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field.full {
      grid-column: 1 / -1;
    }

    label {
      display: block;
      font-size: 10px;
      font-family: 'Cinzel', serif;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-muted);
    }

    input, select, textarea {
      width: 100%;
      box-sizing: border-box;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: rgba(10, 9, 8, 0.6);
      color: var(--text-primary);
      padding: 8px 10px;
      font-family: 'Crimson Text', serif;
      font-size: 13px;
      transition: all 0.2s ease;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent-violet);
      box-shadow: 0 0 15px rgba(139, 92, 246, 0.2);
      background: rgba(10, 9, 8, 0.8);
    }

    input::placeholder {
      color: var(--text-muted);
    }

    textarea {
      min-height: 180px;
      font-family: 'JetBrains Mono', 'Consolas', monospace;
      font-size: 12px;
      line-height: 1.6;
      resize: vertical;
    }

    textarea[readonly] {
      background: rgba(10, 9, 8, 0.4);
      color: var(--text-muted);
      border-color: transparent;
    }

    select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23a8a29e' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    .status-bar {
      padding: 14px 20px;
      font-size: 12px;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
      background: linear-gradient(0deg, rgba(41, 37, 36, 0.4), transparent);
    }

    .status-bar::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent-emerald);
      box-shadow: 0 0 8px var(--accent-emerald);
    }

    .status-bar.ok::before {
      background: var(--accent-emerald);
      box-shadow: 0 0 8px var(--accent-emerald);
    }

    .status-bar.err::before {
      background: var(--accent-rose);
      box-shadow: 0 0 8px var(--accent-rose);
    }

    .hint {
      color: var(--text-muted);
      font-size: 13px;
    }

    .ok {
      color: var(--accent-emerald);
    }

    .err {
      color: var(--accent-rose);
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-muted);
      font-size: 14px;
      gap: 12px;
      padding: 40px;
      text-align: center;
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      opacity: 0.3;
    }

    .chapter-icon {
      width: 20px;
      height: 20px;
      margin-right: 4px;
      vertical-align: middle;
    }

    .field-group {
      grid-column: 1 / -1;
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding-top: 8px;
      border-top: 1px solid var(--border);
    }

    .field-group-title {
      font-family: 'Cinzel', serif;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--accent-cyan);
      margin-bottom: 4px;
    }

    .wave-editor {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .wave-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 200px;
      overflow-y: auto;
      padding: 8px;
      background: rgba(10, 9, 8, 0.4);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .wave-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: rgba(28, 25, 23, 0.6);
      border: 1px solid var(--border);
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .wave-item:hover {
      border-color: var(--accent-violet);
      background: rgba(139, 92, 246, 0.1);
    }

    .wave-item.active {
      border-color: var(--accent-violet);
      background: rgba(139, 92, 246, 0.15);
      box-shadow: 0 0 10px rgba(139, 92, 246, 0.2);
    }

    .wave-number {
      font-family: 'Cinzel', serif;
      font-size: 10px;
      font-weight: 600;
      color: var(--accent-cyan);
      min-width: 40px;
    }

    .wave-monsters {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .wave-monster-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      background: rgba(139, 92, 246, 0.2);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 4px;
      font-size: 11px;
      color: var(--text-primary);
    }

    .wave-monster-tag .count {
      font-weight: 600;
      color: var(--accent-amber);
    }

    .wave-actions {
      display: flex;
      gap: 6px;
    }

    .wave-actions button {
      padding: 4px 8px;
      font-size: 10px;
      min-width: auto;
    }

    .wave-add-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px;
      border: 1px dashed var(--border);
      border-radius: 6px;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .wave-add-btn:hover {
      border-color: var(--accent-violet);
      color: var(--accent-violet);
      background: rgba(139, 92, 246, 0.1);
    }

    .monster-select-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .monster-select-modal.hidden {
      display: none;
    }

    .monster-select-content {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .monster-select-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .monster-select-header h3 {
      margin: 0;
      font-family: 'Cinzel', serif;
      font-size: 14px;
      color: var(--text-primary);
    }

    .monster-select-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
    }

    .monster-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .monster-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: rgba(10, 9, 8, 0.4);
    }

    .monster-option:hover {
      border-color: var(--accent-violet);
      background: rgba(139, 92, 246, 0.1);
    }

    .monster-option .icon {
      font-size: 24px;
    }

    .monster-option .name {
      font-size: 11px;
      color: var(--text-secondary);
      text-align: center;
    }

    .monster-option .tier {
      font-size: 9px;
      color: var(--accent-amber);
      text-transform: uppercase;
    }
  </style>
</head>
<body>
  <div class="app">
    <section class="panel">
      <div class="panel-header">Á´†ËäÇ</div>
      <div id="chapterList" class="list-container"></div>
      <div class="actions">
        <button id="addChapter">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px; vertical-align: middle;">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Êñ∞Â¢û
        </button>
        <button id="removeChapter" class="danger">Âà†Èô§</button>
      </div>
    </section>

    <section class="panel">
      <div class="panel-header">ËäÇÁÇπ</div>
      <div id="nodeList" class="list-container"></div>
      <div class="actions">
        <button id="addNode">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px; vertical-align: middle;">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Êñ∞Â¢û
        </button>
        <button id="removeNode" class="danger">Âà†Èô§</button>
      </div>
    </section>

    <section class="panel">
      <div class="panel-header">ÁºñËæëÂå∫</div>
      <div id="editor" class="form"></div>
      <div class="actions">
        <button id="reload">ÈáçÊñ∞ÂØºÂÖ•</button>
        <button id="save" class="primary">‰øùÂ≠òÈÖçÁΩÆ</button>
      </div>
      <div id="status" class="status-bar hint">ÂáÜÂ§áÂ∞±Áª™</div>
    </section>
  </div>

  <script>
    const state = {
      chapters: [],
      monsters: [],
      selectedChapter: 0,
      selectedNode: 0,
    };

    const chapterList = document.getElementById('chapterList');
    const nodeList = document.getElementById('nodeList');
    const editor = document.getElementById('editor');
    const status = document.getElementById('status');

    const setStatus = (text, type = '') => {
      status.textContent = text;
      status.className = `status-bar hint ${type}`;
    };

    const getSelectedChapter = () => state.chapters[state.selectedChapter];
    const getSelectedNode = () => getSelectedChapter()?.nodes?.[state.selectedNode];

    function renderChapterList() {
      chapterList.innerHTML = '';
      if (state.chapters.length === 0) {
        chapterList.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
            </svg>
            <span>ÊöÇÊó†Á´†ËäÇÔºåÁÇπÂáª"Êñ∞Â¢û"ÂàõÂª∫</span>
          </div>
        `;
        return;
      }
      state.chapters.forEach((ch, idx) => {
        const div = document.createElement('div');
        div.className = `item ${idx === state.selectedChapter ? 'active' : ''}`;
        div.innerHTML = `
          <div class="item-id">${ch.id}</div>
          <div class="item-name">${ch.name}</div>
        `;
        div.onclick = () => { state.selectedChapter = idx; state.selectedNode = 0; renderAll(); };
        chapterList.appendChild(div);
      });
    }

    function renderNodeList() {
      nodeList.innerHTML = '';
      const chapter = getSelectedChapter();
      if (!chapter) {
        nodeList.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 6v6l4 2"/>
            </svg>
            <span>ËØ∑ÂÖàÈÄâÊã©Á´†ËäÇ</span>
          </div>
        `;
        return;
      }
      if (chapter.nodes.length === 0) {
        nodeList.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 6v6l4 2"/>
            </svg>
            <span>ÊöÇÊó†ËäÇÁÇπÔºåÁÇπÂáª"Êñ∞Â¢û"ÂàõÂª∫</span>
          </div>
        `;
        return;
      }
      chapter.nodes.forEach((node, idx) => {
        const div = document.createElement('div');
        div.className = `item ${idx === state.selectedNode ? 'active' : ''}`;
        const typeIcon = {
          'normal': '‚öîÔ∏è',
          'elite': 'üíÄ',
          'boss': 'üëπ',
          'wave': 'üåä'
        }[node.encounterType] || '‚öîÔ∏è';
        div.innerHTML = `
          <div class="item-id">${node.id}</div>
          <div class="item-name">${typeIcon} ${node.name}</div>
        `;
        div.onclick = () => { state.selectedNode = idx; renderAll(); };
        nodeList.appendChild(div);
      });
    }

    function inputField(label, value, onChange, type = 'text') {
      const wrap = document.createElement('div');
      wrap.className = 'field';
      const lb = document.createElement('label');
      lb.textContent = label;
      const input = document.createElement('input');
      input.type = type;
      input.value = value ?? '';
      input.oninput = (e) => onChange(e.target.value);
      input.placeholder = `ËæìÂÖ• ${label}...`;
      wrap.append(lb, input);
      return wrap;
    }

    function selectField(label, value, options, onChange) {
      const wrap = document.createElement('div');
      wrap.className = 'field';
      const lb = document.createElement('label');
      lb.textContent = label;
      const sel = document.createElement('select');
      options.forEach((opt) => {
        const o = document.createElement('option');
        o.value = opt;
        o.textContent = opt;
        sel.appendChild(o);
      });
      sel.value = value;
      sel.onchange = (e) => onChange(e.target.value);
      wrap.append(lb, sel);
      return wrap;
    }

    function textAreaField(label, value, onChange, readonly = false) {
      const wrap = document.createElement('div');
      wrap.className = 'field full';
      const lb = document.createElement('label');
      lb.textContent = label;
      const ta = document.createElement('textarea');
      ta.value = value;
      ta.oninput = (e) => onChange(e.target.value);
      if (readonly) {
        ta.setAttribute('readonly', 'readonly');
      }
      wrap.append(lb, ta);
      return wrap;
    }

    function renderEditor() {
      editor.innerHTML = '';
      const chapter = getSelectedChapter();
      const node = getSelectedNode();
      if (!chapter || !node) {
        editor.innerHTML = `
          <div class="empty-state full" style="grid-column: 1 / -1;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"/>
            </svg>
            <span>ËØ∑ÈÄâÊã©Á´†ËäÇÂíåËäÇÁÇπ</span>
          </div>
        `;
        return;
      }

      const chapterTitle = document.createElement('div');
      chapterTitle.className = 'field-group';
      chapterTitle.innerHTML = '<div class="field-group-title">Á´†ËäÇÈÖçÁΩÆ</div>';
      editor.appendChild(chapterTitle);

      editor.append(
        inputField('Á´†ËäÇID', chapter.id, (v) => chapter.id = v),
        inputField('Á´†ËäÇÂêç', chapter.name, (v) => chapter.name = v),
        inputField('Á≠âÁ∫ßËåÉÂõ¥', chapter.levelRange, (v) => chapter.levelRange = v),
        inputField('‰∏ªÈ¢ò', chapter.theme, (v) => chapter.theme = v),
      );

      const nodeTitle = document.createElement('div');
      nodeTitle.className = 'field-group';
      nodeTitle.innerHTML = '<div class="field-group-title">ËäÇÁÇπÈÖçÁΩÆ</div>';
      editor.appendChild(nodeTitle);

      editor.append(
        inputField('ËäÇÁÇπID', node.id, (v) => node.id = v),
        inputField('ËäÇÁÇπÂêç', node.name, (v) => node.name = v),
        inputField('Êé®ËçêÁ≠âÁ∫ß', node.recommendedLevel, (v) => node.recommendedLevel = Number(v || 1), 'number'),
        inputField('È¶ñÊ¨°ÈáëÂ∏Å', node.firstClearRewardGold, (v) => node.firstClearRewardGold = Number(v || 0), 'number'),
      );

      const waveText = JSON.stringify(node.waves || [], null, 2);
      
      const waveEditorWrap = document.createElement('div');
      waveEditorWrap.className = 'field full';
      
      const waveLabel = document.createElement('label');
      waveLabel.textContent = 'Waves ÈÖçÁΩÆ';
      waveEditorWrap.appendChild(waveLabel);
      
      const waveList = document.createElement('div');
      waveList.className = 'wave-list';
      
      const waves = node.waves || [];
      if (waves.length === 0) {
        waveList.innerHTML = '<div class="hint" style="text-align:center;padding:20px;">ÊöÇÊó†Ê≥¢Ê¨°ÔºåÁÇπÂáª‰∏ãÊñπÊ∑ªÂä†</div>';
      } else {
        waves.forEach((wave, waveIdx) => {
          const waveItem = document.createElement('div');
          waveItem.className = 'wave-item';
          
          const waveNum = document.createElement('span');
          waveNum.className = 'wave-number';
          waveNum.textContent = `Ê≥¢Ê¨° ${waveIdx + 1}`;
          
          const monsterTags = document.createElement('div');
          monsterTags.className = 'wave-monsters';
          
          if (wave.monsters && wave.monsters.length > 0) {
            wave.monsters.forEach((m, mIdx) => {
              const tag = document.createElement('span');
              tag.className = 'wave-monster-tag';
              tag.innerHTML = `<span>${m.icon || 'üëæ'}</span><span class="count">x${m.count || 1}</span>`;
              tag.title = m.id;
              monsterTags.appendChild(tag);
            });
          } else {
            monsterTags.innerHTML = '<span class="hint" style="font-size:11px;">ÁÇπÂáªÊ∑ªÂä†ÊÄ™Áâ©</span>';
          }
          
          const actions = document.createElement('div');
          actions.className = 'wave-actions';
          
          const addBtn = document.createElement('button');
          addBtn.textContent = '+';
          addBtn.title = 'Ê∑ªÂä†ÊÄ™Áâ©';
          addBtn.onclick = () => openMonsterSelect(waveIdx);
          actions.appendChild(addBtn);
          
          const delBtn = document.createElement('button');
          delBtn.textContent = '√ó';
          delBtn.title = 'Âà†Èô§Ê≥¢Ê¨°';
          delBtn.onclick = () => {
            node.waves.splice(waveIdx, 1);
            renderAll();
            setStatus('Â∑≤Âà†Èô§Ê≥¢Ê¨°', 'ok');
          };
          actions.appendChild(delBtn);
          
          waveItem.appendChild(waveNum);
          waveItem.appendChild(monsterTags);
          waveItem.appendChild(actions);
          waveList.appendChild(waveItem);
        });
      }
      
      const addWaveBtn = document.createElement('button');
      addWaveBtn.className = 'wave-add-btn';
      addWaveBtn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> Ê∑ªÂä†Ê≥¢Ê¨°';
      addWaveBtn.onclick = () => {
        if (!node.waves) node.waves = [];
        node.waves.push({ monsters: [] });
        renderAll();
        setStatus('Â∑≤Ê∑ªÂä†Ê≥¢Ê¨°', 'ok');
      };
      
      waveEditorWrap.appendChild(waveList);
      waveEditorWrap.appendChild(addWaveBtn);
      editor.appendChild(waveEditorWrap);

      const monsters = state.monsters.map((m) => `${m.icon} ${m.id} (Tier ${m.tier})`).join('\n');
      editor.append(textAreaField('ÂèØÁî®ÊÄ™Áâ©ÂèÇËÄÉ (Âè™ËØª)', monsters, () => {}, true));
    }

    function renderAll() {
      renderChapterList();
      renderNodeList();
      renderEditor();
    }

    async function loadConfig() {
      setStatus('Ê≠£Âú®ÂØºÂÖ•ÈÖçÁΩÆ...');
      const res = await fetch('/api/config');
      const data = await res.json();
      state.chapters = data.chapters || [];
      state.monsters = data.monsters || [];
      state.selectedChapter = 0;
      state.selectedNode = 0;
      renderAll();
      setStatus(`Â∑≤ÂØºÂÖ•Ôºö${state.chapters.length} ‰∏™Á´†ËäÇÔºå${state.monsters.length} ‰∏™ÊÄ™Áâ©`, 'ok');
    }

    async function saveConfig() {
      setStatus('Ê≠£Âú®‰øùÂ≠ò...');
      const res = await fetch('/api/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ chapters: state.chapters }),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || '‰øùÂ≠òÂ§±Ë¥•');
      setStatus('‰øùÂ≠òÊàêÂäüÔºöÂ∑≤ÂÜôÂÖ• src/config/map/mapdata.json', 'ok');
    }

    document.getElementById('reload').onclick = loadConfig;
    document.getElementById('save').onclick = () => saveConfig().catch((e) => setStatus(e.message, 'err'));

    document.getElementById('addChapter').onclick = () => {
      const id = `chapter-${state.chapters.length + 1}`;
      state.chapters.push({
        id,
        name: 'Êñ∞Á´†ËäÇ',
        levelRange: 'Lv.1-10',
        theme: 'ÈªòËÆ§',
        nodes: [{
          id: `${state.chapters.length + 1}-1`,
          name: 'Êñ∞ËäÇÁÇπ',
          recommendedLevel: 1,
          encounterType: 'normal',
          firstClearRewardGold: 100,
          position: { x: 50, y: 50 }
        }]
      });
      state.selectedChapter = state.chapters.length - 1;
      state.selectedNode = 0;
      renderAll();
    };

    document.getElementById('removeChapter').onclick = () => {
      if (!state.chapters.length) return;
      if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Á´†ËäÇÂêóÔºü')) return;
      state.chapters.splice(state.selectedChapter, 1);
      state.selectedChapter = Math.max(0, state.selectedChapter - 1);
      state.selectedNode = 0;
      renderAll();
    };

    document.getElementById('addNode').onclick = () => {
      const chapter = getSelectedChapter();
      if (!chapter) return;
      chapter.nodes.push({
        id: `${chapter.id}-node-${chapter.nodes.length + 1}`,
        name: 'Êñ∞ËäÇÁÇπ',
        recommendedLevel: 1,
        encounterType: 'normal',
        firstClearRewardGold: 100,
        position: { x: 50, y: 50 }
      });
      state.selectedNode = chapter.nodes.length - 1;
      renderAll();
    };

    document.getElementById('removeNode').onclick = () => {
      const chapter = getSelectedChapter();
      if (!chapter || !chapter.nodes.length) return;
      if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ËäÇÁÇπÂêóÔºü')) return;
      chapter.nodes.splice(state.selectedNode, 1);
      state.selectedNode = Math.max(0, state.selectedNode - 1);
      renderAll();
    };

    loadConfig().catch((e) => setStatus(e.message, 'err'));

    let currentWaveIdx = -1;
    let monsterModal = null;

    function openMonsterSelect(waveIdx) {
      currentWaveIdx = waveIdx;
      const chapter = getSelectedChapter();
      const node = getSelectedNode();
      if (!node || !node.waves || !node.waves[waveIdx]) return;

      if (!monsterModal) {
        monsterModal = document.createElement('div');
        monsterModal.className = 'monster-select-modal hidden';
        monsterModal.id = 'monsterModal';
        monsterModal.onclick = (e) => {
          if (e.target === monsterModal) closeMonsterSelect();
        };
        monsterModal.innerHTML = `
          <div class="monster-select-content">
            <div class="monster-select-header">
              <h3>ÈÄâÊã©ÊÄ™Áâ©</h3>
              <button class="monster-select-close" onclick="closeMonsterSelect()">‚úï</button>
            </div>
            <div class="monster-grid" id="monsterGrid"></div>
            <div style="margin-top:16px;display:flex;gap:8px;align-items:center;">
              <label style="margin:0;">Êï∞Èáè:</label>
              <input type="number" id="monsterCount" value="1" min="1" max="99" style="width:60px;">
              <button onclick="confirmAddMonster()" class="primary" style="flex:1;">Ê∑ªÂä†</button>
            </div>
          </div>
        `;
        document.body.appendChild(monsterModal);
      }

      const grid = monsterModal.querySelector('#monsterGrid');
      grid.innerHTML = '';
      state.monsters.forEach((m) => {
        const opt = document.createElement('div');
        opt.className = 'monster-option';
        opt.dataset.id = m.id;
        opt.dataset.icon = m.icon || 'üëæ';
        opt.innerHTML = `
          <span class="icon">${m.icon || 'üëæ'}</span>
          <span class="name">${m.id}</span>
          <span class="tier">Tier ${m.tier || 1}</span>
        `;
        opt.onclick = () => {
          grid.querySelectorAll('.monster-option').forEach(o => o.style.border = '');
          opt.style.borderColor = 'var(--accent-violet)';
          opt.style.background = 'rgba(139, 92, 246, 0.2)';
        };
        grid.appendChild(opt);
      });

      monsterModal.classList.remove('hidden');
    }

    function closeMonsterSelect() {
      if (monsterModal) {
        monsterModal.classList.add('hidden');
      }
      currentWaveIdx = -1;
    }

    function confirmAddMonster() {
      const chapter = getSelectedChapter();
      const node = getSelectedNode();
      if (!node || !node.waves || !node.waves[currentWaveIdx]) return;

      const selected = document.querySelector('.monster-option[style*="rgb")');
      const opt = monsterModal.querySelector('.monster-option:hover');
      const target = selected || opt;
      
      if (!target) {
        setStatus('ËØ∑ÂÖàÈÄâÊã©ÊÄ™Áâ©', 'err');
        return;
      }

      const count = parseInt(document.getElementById('monsterCount').value) || 1;
      const monster = {
        id: target.dataset.id,
        icon: target.dataset.icon,
        count: count
      };

      if (!node.waves[currentWaveIdx].monsters) {
        node.waves[currentWaveIdx].monsters = [];
      }
      node.waves[currentWaveIdx].monsters.push(monster);
      
      closeMonsterSelect();
      renderAll();
      setStatus(`Â∑≤Ê∑ªÂä† ${monster.icon} x${count}`, 'ok');
    }
  </script>
</body>
</html>
